<app-page-title [title]="' '" icon="fas fa-clipboard-check">
  <!-- Session Actions -->
  <div class="session-actions">
    <button class="btn btn-secondary" (click)="cancelSession()">
      <i class="fas fa-times"></i>
      {{ "INVENTORY_SESSION.CANCEL" | translate }}
    </button>
    <button
      class="btn btn-success"
      (click)="completeSession()"
      [disabled]="session().updates.length === 0"
    >
      <i class="fas fa-check"></i>
      {{ "INVENTORY_SESSION.COMPLETE" | translate }}
    </button>
  </div>
</app-page-title>

<div class="inventory-session-container">
  <!-- Session Info Bar -->
  <div class="session-info">
    <div class="session-info-item">
      <i class="fas fa-user"></i>
      <span>{{ session().startedBy }}</span>
    </div>
    <div class="session-info-item">
      <i class="fas fa-clock"></i>
      <span>{{ session().startedAt | date: "short" }}</span>
    </div>
    <div class="session-info-item">
      <label class="stock-registration-toggle">
        <input type="checkbox" [(ngModel)]="isStockRegistration" />
        <i class="fas fa-box-open"></i>
        <span>{{
          "INVENTORY_SESSION.STOCK_REGISTRATION_MODE" | translate
        }}</span>
      </label>
    </div>
    <div class="session-info-item">
      <i class="fas fa-list"></i>
      <span
        >{{ session().updates.length }}
        {{ "INVENTORY_SESSION.UPDATES" | translate }}</span
      >
    </div>
  </div>

  <!-- Product Edit Section -->
  <div class="product-editor">
    <!-- Product Edit Form -->
    @if (currentProduct) {
      <div class="product-form">
        <div class="form-left">
          <!-- Product Image -->
          <div class="product-image">
            @if (currentProduct.local_image) {
              <img
                [src]="apiUrl + '/' + currentProduct.local_image"
                [alt]="currentProduct.name"
              />
            }
            @if (!currentProduct.local_image) {
              <div class="no-image">
                <i class="fas fa-image"></i>
              </div>
            }
          </div>
          <div class="product-name">{{ currentProduct.name }}</div>
          @if (currentProduct.category) {
            <div class="product-category">
              {{ currentProduct.category }}
            </div>
          }
        </div>
        <div class="form-right">
          <form (submit)="updateProduct()">
            <!-- EAN Field -->
            <div class="form-group">
              <label for="ean-input">
                <i class="fas fa-barcode"></i>
                {{ "PRODUCTS.EAN" | translate }}
              </label>
              <input
                id="ean-input"
                type="text"
                [(ngModel)]="newEan"
                name="ean"
                class="form-control"
                [placeholder]="currentProduct.ean || ''"
              />
            </div>
            <!-- Price Field (Main Focus) -->
            <div class="form-group highlight">
              <label for="price-input">
                <i class="fas fa-dollar-sign"></i>
                {{ "PRODUCTS.PRICE" | translate }}
              </label>
              <div class="input-with-change">
                <input
                  id="price-input"
                  type="number"
                  [(ngModel)]="newPrice"
                  name="price"
                  class="form-control"
                  step="0.01"
                  min="0"
                  required
                />
                @if (newPrice !== currentProduct.price) {
                  <span
                    class="change-indicator"
                    [class.positive]="newPrice > currentProduct.price"
                    [class.negative]="newPrice < currentProduct.price"
                  >
                    {{ newPrice - currentProduct.price > 0 ? "+" : ""
                    }}{{ newPrice - currentProduct.price | appCurrency }}
                  </span>
                }
              </div>
              <div class="old-value">
                {{ "INVENTORY_SESSION.CURRENT" | translate }}:
                {{ currentProduct.price | appCurrency }}
              </div>
            </div>
            <!-- Stock Field (Main Focus) -->
            <div class="form-group highlight">
              <label for="stock-input">
                <i class="fas fa-boxes"></i>
                {{ "PRODUCTS.STOCK" | translate }}
              </label>
              <div class="input-with-change">
                <input
                  id="stock-input"
                  type="number"
                  [(ngModel)]="newStock"
                  name="stock"
                  class="form-control"
                  step="1"
                  min="0"
                  required
                />
                @if (newStock !== (currentProduct.stock || 0)) {
                  <span
                    class="change-indicator"
                    [class.positive]="newStock > (currentProduct.stock || 0)"
                    [class.negative]="newStock < (currentProduct.stock || 0)"
                  >
                    {{ newStock - (currentProduct.stock || 0) > 0 ? "+" : ""
                    }}{{ newStock - (currentProduct.stock || 0) }}
                  </span>
                }
              </div>
              <div class="old-value">
                {{ "INVENTORY_SESSION.CURRENT" | translate }}:
                {{ currentProduct.stock }}
              </div>
            </div>
            <!-- Action Buttons -->
            <div class="form-actions">
              <button type="submit" class="btn btn-primary" [disabled]="saving">
                <i class="fas fa-save"></i>
                {{ "INVENTORY_SESSION.UPDATE" | translate }}
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="clearProduct()"
                [disabled]="saving"
              >
                <i class="fas fa-times"></i>
                {{ "INVENTORY_SESSION.SKIP" | translate }}
              </button>
            </div>
          </form>
        </div>
      </div>
    }

    <!-- Empty State -->
    @if (!currentProduct) {
      <div class="empty-state">
        <i class="fas fa-search"></i>
        <p>{{ "INVENTORY_SESSION.EMPTY_STATE" | translate }}</p>
      </div>
    }
  </div>

  <!-- Updates Table -->
  @if (session().updates.length > 0) {
    <div class="updates-section">
      <h3>
        <i class="fas fa-history"></i>
        {{ "INVENTORY_SESSION.RECENT_UPDATES" | translate }}
      </h3>
      <div class="table-container">
        <table class="table">
          <thead>
            <tr>
              <th>{{ "INVENTORY_SESSION.TIME" | translate }}</th>
              <th>{{ "PRODUCTS.NAME" | translate }}</th>
              <th>{{ "PRODUCTS.EAN" | translate }}</th>
              <th>{{ "INVENTORY_SESSION.PRICE_CHANGE" | translate }}</th>
              <th>{{ "INVENTORY_SESSION.STOCK_CHANGE" | translate }}</th>
            </tr>
          </thead>
          <tbody>
            @for (update of session().updates; track update) {
              <tr>
                <td>{{ update.timestamp | date: "shortTime" }}</td>
                <td>{{ update.productName }}</td>
                <td>
                  <span class="ean-code">{{ update.ean || "-" }}</span>
                </td>
                <td>
                  <div class="change-cell">
                    <span class="old-val">{{
                      update.oldPrice | appCurrency
                    }}</span>
                    <i class="fas fa-arrow-right"></i>
                    <span class="new-val">{{
                      update.newPrice | appCurrency
                    }}</span>
                    @if (getPriceChange(update) !== 0) {
                      <span
                        class="change-badge"
                        [class.positive]="getPriceChange(update) > 0"
                        [class.negative]="getPriceChange(update) < 0"
                      >
                        {{ getPriceChange(update) > 0 ? "+" : ""
                        }}{{ getPriceChange(update) | appCurrency }}
                      </span>
                    }
                  </div>
                </td>
                <td>
                  <div class="change-cell">
                    <span class="old-val">{{ update.oldStock }}</span>
                    <i class="fas fa-arrow-right"></i>
                    <span class="new-val">{{ update.newStock }}</span>
                    @if (getStockChange(update) !== 0) {
                      <span
                        class="change-badge"
                        [class.positive]="getStockChange(update) > 0"
                        [class.negative]="getStockChange(update) < 0"
                      >
                        {{ getStockChange(update) > 0 ? "+" : ""
                        }}{{ getStockChange(update) }}
                      </span>
                    }
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</div>
