<div class="cashier-container">
  <!-- Register Warning Banner -->
  <div class="register-warning" *ngIf="!currentRegister()">
    <i class="fas fa-exclamation-triangle"></i>
    <span>{{ "CASHIER.REGISTER_WARNING" | translate }}</span>
    <button class="open-register-btn" (click)="openRegisterModal()">
      <i class="fas fa-door-open"></i>
      {{ "CASHIER.OPEN_REGISTER" | translate }}
    </button>
  </div>

  <div class="cashier-content">
    <!-- Mobile Tabs (calculator / sales) -->
    <div class="mobile-tabs" role="tablist" aria-label="Cashier Tabs">
      <button
        type="button"
        class="tab-btn"
        role="tab"
        aria-selected="{{ activeTab() === 'calculator' }}"
        (click)="activeTab.set('calculator')"
      >
        <i class="fas fa-calculator"></i>
        <span>Calc</span>
      </button>
      <button
        type="button"
        class="tab-btn"
        role="tab"
        aria-selected="{{ activeTab() === 'sales' }}"
        (click)="activeTab.set('sales')"
      >
        <i class="fas fa-list"></i>
        <span>Sales</span>
      </button>
    </div>
    <!-- Left Side - Calculator -->
    <div
      class="calculator-section"
      [class.mobile-hidden]="activeTab() !== 'calculator'"
    >
      <app-calculator
        [lastItemPrice]="getLastItemPrice()"
        [itemsCount]="items().length"
        [selectedItemId]="selectedItemId()"
        (addItem)="onCalculatorAdd($event)"
        (multiplyConfirm)="onCalculatorMultiplyConfirm($event)"
        (looseProductRequest)="openLooseProductModal()"
      >
      </app-calculator>
    </div>

    <!-- Right Side - Items & Payment -->
    <div class="sales-section">
      <!-- Items List (hidden on mobile when sales tab inactive) -->
      <div class="items-panel" [class.mobile-hidden]="activeTab() !== 'sales'">
        <div class="panel-header">
          <h3>
            <i class="fas fa-list"></i>
            {{ "CASHIER.ITEMS.TITLE" | translate }}
          </h3>
          <div class="header-actions">
            <!-- Item count and clear button moved to total section -->
          </div>
        </div>

        <div class="items-list" *ngIf="items().length > 0; else noItems">
          <div
            class="item-row"
            *ngFor="let item of items()"
            [class.selected]="selectedItemId() === item.id"
          >
            <div class="item-actions">
              <button
                class="qty-btn decrease"
                (click)="decreaseQuantity(item.id); $event.stopPropagation()"
                title="Decrease quantity"
              >
                <i class="fas fa-minus"></i>
              </button>
              <span class="qty-display">{{ item.quantity }}</span>
              <button
                class="qty-btn increase"
                (click)="increaseQuantity(item.id); $event.stopPropagation()"
                title="Increase quantity"
              >
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div
              class="item-info"
              (click)="editItem(item.id)"
              title="Click to edit"
            >
              <div class="item-header">
                <span class="item-number">#{{ item.id + 1 }}</span>
                <div class="item-price-section">
                  <span class="item-quantity" *ngIf="item.quantity > 1"
                    >{{ item.quantity }}x</span
                  >
                  <span class="item-unit-price" *ngIf="item.quantity > 1"
                    >{{ item.unitPrice | appCurrency }} =</span
                  >
                  <span class="item-price">{{ item.price | appCurrency }}</span>
                </div>
              </div>
              <div class="item-details" *ngIf="item.description || item.weight">
                <span class="item-description" *ngIf="item.description">
                  <i class="fas fa-tag"></i>
                  {{ item.description }}
                </span>
                <span
                  class="item-weight"
                  *ngIf="item.weight && item.pricePerKg"
                >
                  <i class="fas fa-weight"></i>
                  {{ item.weight.toFixed(3) }}kg @
                  {{ item.pricePerKg | appCurrency }}/kg
                </span>
              </div>
            </div>
            <div class="item-end-actions">
              <button
                class="remove-btn"
                (click)="removeItem(item.id); $event.stopPropagation()"
                title="Remove item"
              >
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>

        <ng-template #noItems>
          <div class="no-items">
            <i class="fas fa-shopping-basket"></i>
            <p>{{ "CASHIER.ITEMS.EMPTY" | translate }}</p>
            <p class="hint">{{ "CASHIER.ITEMS.HINT" | translate }}</p>
          </div>
        </ng-template>
      </div>

      <!-- Total Section -->
      <div class="total-section">
        <div class="total-display">
          <span class="total-label">{{
            "CASHIER.TOTAL_LABEL" | translate
          }}</span>
          <span class="total-value">{{ total() | appCurrency }}</span>
        </div>
        <div class="total-actions">
          <span class="item-count"
            >{{ items().length }} {{ "CASHIER.ITEMS.TITLE" | translate }}</span
          >
          <button
            class="clear-all-btn"
            (click)="clearAllItems()"
            [disabled]="items().length === 0"
            title="{{ 'GLOBAL.CLEAR' | translate }}"
          >
            <i class="fas fa-trash"></i>
            <span class="btn-text">{{ "GLOBAL.CLEAR" | translate }}</span>
          </button>
        </div>
      </div>

      <!-- Payment Buttons -->
      <div class="payment-section">
        <div class="payment-buttons">
          <button
            class="payment-btn cash"
            (click)="completeSale('cash')"
            [disabled]="items().length === 0 || isProcessing()"
          >
            <i class="fas fa-money-bill-wave"></i>
            <span>{{ "CASHIER.PAYMENTS.CASH" | translate }}</span>
          </button>
          <button
            class="payment-btn card"
            (click)="completeSale('card')"
            [disabled]="items().length === 0 || isProcessing()"
          >
            <i class="fas fa-credit-card"></i>
            <span>{{ "CASHIER.PAYMENTS.CARD" | translate }}</span>
          </button>
          <button
            class="payment-btn internal"
            (click)="completeSale('internal')"
            [disabled]="items().length === 0 || isProcessing()"
          >
            <i class="fas fa-building"></i>
            <span>{{ "CASHIER.PAYMENTS.INTERNAL" | translate }}</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Payment Confirmation Modal -->
  @if (showPaymentModal()) {
    <div
      class="modal-overlay"
      role="dialog"
      aria-modal="true"
      tabindex="0"
      (click)="cancelPayment()"
    >
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>
            <i
              class="fas"
              [class.fa-money-bill-wave]="selectedPaymentMethod() === 'cash'"
              [class.fa-credit-card]="selectedPaymentMethod() === 'card'"
              [class.fa-building]="selectedPaymentMethod() === 'internal'"
            ></i>
            {{
              selectedPaymentMethod() === "cash"
                ? ("CASHIER.PAYMENT.TITLE.CASH" | translate)
                : selectedPaymentMethod() === "card"
                  ? ("CASHIER.PAYMENT.TITLE.CARD" | translate)
                  : ("CASHIER.PAYMENT.TITLE.INTERNAL" | translate)
            }}
          </h2>
          <button class="close-btn" (click)="cancelPayment()">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="sale-total">
            <span class="label">{{
              "CASHIER.PAYMENT.TOTAL_AMOUNT" | translate
            }}</span>
            <span class="value">{{ total() | appCurrency }}</span>
          </div>

          <!-- Cash Payment Form -->
          @if (selectedPaymentMethod() === "cash") {
            <div class="cash-payment">
              <!-- Number Keyboard -->
              <app-number-keyboard
                (valueChange)="onKeyboardInput($event)"
              ></app-number-keyboard>

              <div
                class="change-display"
                [class.insufficient]="
                  !cashReceived() || parseFloat(cashReceived()) < total()
                "
              >
                <span class="change-label">{{
                  "CASHIER.PAYMENT.CHANGE" | translate
                }}</span>
                <span class="change-value">{{ change() | appCurrency }}</span>
              </div>
            </div>
          }

          <!-- Card/Internal Confirmation -->
          @if (selectedPaymentMethod() !== "cash") {
            <div class="confirmation-message">
              <i class="fas fa-check-circle"></i>
              <p>
                {{
                  "CASHIER.PAYMENT.CONFIRM_MESSAGE"
                    | translate: { method: selectedPaymentMethod() }
                }}
              </p>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button
            class="modal-btn cancel"
            (click)="cancelPayment()"
            [disabled]="isProcessing()"
          >
            {{ "GLOBAL.CANCEL" | translate }}
          </button>
          <button
            class="modal-btn confirm"
            (click)="confirmPayment()"
            [disabled]="isProcessing()"
          >
            @if (!isProcessing()) {
              <span>{{ "CASHIER.PAYMENT.CONFIRM_PAYMENT" | translate }}</span>
            }
            @if (isProcessing()) {
              <span>{{ "CASHIER.PAYMENT.PROCESSING" | translate }}</span>
            }
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Loose Product Modal -->
  @if (showLooseProductModal()) {
    <div
      class="modal-overlay"
      role="dialog"
      aria-modal="true"
      (click)="cancelLooseProduct()"
    >
      <div
        class="modal-content loose-product-modal"
        role="document"
        (click)="$event.stopPropagation()"
      >
        <div class="modal-body">
          <button class="close-btn" (click)="cancelLooseProduct()">
            <i class="fas fa-times"></i>
          </button>
          <!-- Scale Connection Section -->
          <div class="scale-connection">
            <div class="scale-status">
              <i
                class="fas fa-scale-balanced"
                [class.connected]="scaleConnected()"
              ></i>
              <span>
                {{ "CASHIER.SCALE.LABEL" | translate }}:
                {{
                  scaleConnected()
                    ? ("CASHIER.SCALE.CONNECTED" | translate)
                    : ("CASHIER.SCALE.NOT_CONNECTED" | translate)
                }}
              </span>
            </div>
            @if (!scaleConnected()) {
              <button class="scale-btn" (click)="connectToScale()">
                <i class="fas fa-plug"></i>
                {{ "CASHIER.SCALE.CONNECT" | translate }}
              </button>
            }
          </div>

          <!-- Current Scale Reading -->
          @if (currentScaleReading() && scaleConnected()) {
            <div class="scale-reading">
              <div
                class="reading-display"
                [class.stable]="currentScaleReading()!.stable"
              >
                <i class="fas fa-weight-hanging"></i>
                <span class="weight">{{
                  currentScaleReading()!.weight.toFixed(3)
                }}</span>
                <span class="unit">{{ currentScaleReading()!.unit }}</span>
                @if (currentScaleReading()!.stable) {
                  <span class="status-badge">
                    <i class="fas fa-check"></i> Stable
                  </span>
                }
              </div>
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="useScaleWeight()"
                  (change)="toggleUseScaleWeight()"
                />
                <span>{{ "CASHIER.SCALE.USE_SCALE_LABEL" | translate }}</span>
              </label>
            </div>
          }

          <!-- Product Information Form -->
          <div class="form-group">
            <input
              id="productDescription"
              type="text"
              [(ngModel)]="looseProductDescription"
              placeholder="{{
                'CASHIER.LOOSE_PRODUCT_MODAL.DESCRIPTION_PLACEHOLDER'
                  | translate
              }}"
              class="form-input"
            />
          </div>

          <div class="form-group">
            <input
              #weightInput
              id="weight"
              type="number"
              step="0.001"
              min="0"
              [(ngModel)]="looseProductWeight"
              placeholder="Enter weight in kg"
              class="form-input"
              [class.invalid]="
                looseProductWeight() && parseFloat(looseProductWeight()) <= 0
              "
              [readonly]="useScaleWeight() && scaleConnected()"
              (keydown.enter)="handleLooseProductEnter($event)"
            />
            @if (useScaleWeight() && scaleConnected()) {
              <small class="help-text">
                <i class="fas fa-info-circle"></i>
                {{ "CASHIER.SCALE.WEIGHT_AUTOMATIC" | translate }}
              </small>
            }
          </div>

          <div class="form-group">
            <input
              #pricePerKgInput
              id="pricePerKg"
              type="number"
              step="0.01"
              min="0"
              [(ngModel)]="looseProductPricePerKg"
              placeholder="Enter price per kg"
              class="form-input"
              [class.invalid]="
                looseProductPricePerKg() &&
                parseFloat(looseProductPricePerKg()) <= 0
              "
              (keydown.enter)="handleLooseProductEnter($event)"
            />
          </div>

          <!-- Total Preview -->
          @if (
            looseProductWeight() &&
            looseProductPricePerKg() &&
            parseFloat(looseProductWeight()) > 0 &&
            parseFloat(looseProductPricePerKg()) > 0
          ) {
            <div class="total-preview">
              <span class="preview-label">Total Price:</span>
              <span class="preview-value">
                {{
                  parseFloat(looseProductWeight()) *
                    parseFloat(looseProductPricePerKg()) | appCurrency
                }}
              </span>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button class="modal-btn cancel" (click)="cancelLooseProduct()">
            Cancel
          </button>
          <button class="modal-btn confirm" (click)="confirmLooseProduct()">
            <i class="fas fa-check"></i>
            Add Item
          </button>
        </div>
      </div>
    </div>
  }
</div>

<!-- Open Register Modal -->
@if (showOpenRegisterModal()) {
  <div
    class="modal-overlay"
    role="dialog"
    aria-modal="true"
    tabindex="0"
    (click)="closeRegisterModal()"
  >
    <div (click)="$event.stopPropagation()">
      <app-open-register
        (registerOpened)="onRegisterOpened()"
        (cancelled)="closeRegisterModal()"
      ></app-open-register>
    </div>
  </div>
}
