<div class="page-container">
  <section class="card setting-section">
    <div class="setting-header">
      <div class="header-actions">
        <button class="btn btn-primary" (click)="previewReceipt()">
          {{ "SETTINGS.PRINTING.PREVIEW" | translate }}
        </button>
        @if (isAdmin) {
          <button
            class="btn btn-secondary"
            routerLink="/templates"
            title="Manage receipt templates"
          >
            {{ "TEMPLATES.TITLE" | translate }}
          </button>
        }
      </div>
    </div>

    <div class="preview-toggle">
      <div class="toggle-container">
        <app-toggle-switch
          [checked]="showPrintPreview"
          (change)="togglePrintPreview($event)"
          size="medium"
        ></app-toggle-switch>
        <span class="toggle-text">
          {{ "SETTINGS.PRINTING.SHOW_PREVIEW" | translate }}
        </span>
      </div>
      <p class="toggle-description">
        {{ "SETTINGS.PRINTING.SHOW_PREVIEW_DESC" | translate }}
      </p>
    </div>

    <div class="options" role="radiogroup" aria-label="Printer Mode">
      <div
        class="option-card"
        role="radio"
        tabindex="0"
        [attr.aria-checked]="printerMode === 'plain'"
        [class.active]="printerMode === 'plain'"
        (click)="setPrinterMode('plain')"
        (keydown.enter)="setPrinterMode('plain')"
      >
        <div class="option-left">
          <div class="icon">T</div>
        </div>
        <div class="option-body">
          <div class="title">{{ "SETTINGS.PRINTING.PLAIN" | translate }}</div>
          <div class="desc">
            {{ "SETTINGS.PRINTING.PLAIN_DESC" | translate }}
          </div>
        </div>
        <div class="option-right"><span class="check">✓</span></div>
      </div>

      <div
        class="option-card"
        role="radio"
        tabindex="0"
        [attr.aria-checked]="printerMode === 'styled'"
        [class.active]="printerMode === 'styled'"
        (click)="setPrinterMode('styled')"
        (keydown.enter)="setPrinterMode('styled')"
      >
        <div class="option-left">
          <div class="icon">S</div>
        </div>
        <div class="option-body">
          <div class="title">{{ "SETTINGS.PRINTING.STYLED" | translate }}</div>
          <div class="desc">
            {{ "SETTINGS.PRINTING.STYLED_DESC" | translate }}
          </div>
        </div>
        <div class="option-right"><span class="check">✓</span></div>
      </div>
    </div>
  </section>

  <section class="card user-section">
    <h3>{{ "SETTINGS.USER_PREFERENCES.TITLE" | translate }}</h3>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.USER_PREFERENCES.DISPLAY_NAME" | translate
      }}</label>
      <input
        type="text"
        [(ngModel)]="displayName"
        placeholder="{{
          'SETTINGS.USER_PREFERENCES.DISPLAY_NAME_PLACEHOLDER' | translate
        }}"
      />
    </div>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.USER_PREFERENCES.LANGUAGE" | translate
      }}</label>
      <select [(ngModel)]="preferredLang">
        <option value="en">{{ "GLOBAL.ENGLISH" | translate }}</option>
        <option value="es">{{ "GLOBAL.SPANISH" | translate }}</option>
      </select>
    </div>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.USER_PREFERENCES.PRINTER_MODE" | translate
      }}</label>
      <select [(ngModel)]="userPrinterMode">
        <option value="inherit">
          {{ "SETTINGS.USER_PREFERENCES.PRINTER_INHERIT" | translate }}
        </option>
        <option value="plain">
          {{ "SETTINGS.PRINTING.PLAIN" | translate }}
        </option>
        <option value="styled">
          {{ "SETTINGS.PRINTING.STYLED" | translate }}
        </option>
      </select>
    </div>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.USER_PREFERENCES.DEFAULT_PRINTER" | translate
      }}</label>
      <select [(ngModel)]="defaultPrinter" (change)="onDefaultPrinterChange()">
        @for (printer of availablePrinters; track printer) {
          <option [value]="printer">
            {{ printer }}
          </option>
        }
      </select>
      <p class="form-hint">
        {{ "SETTINGS.USER_PREFERENCES.DEFAULT_PRINTER_DESC" | translate }}
      </p>
    </div>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.USER_PREFERENCES.CURRENCY" | translate
      }}</label>
      <select [(ngModel)]="selectedCurrency">
        @for (currency of currencyService.currencies; track currency) {
          <option [value]="currency.code">
            {{ currency.symbol }} - {{ currency.name }} ({{ currency.code }})
          </option>
        }
      </select>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" (click)="saveUserSettings()">
        {{ "SETTINGS.USER_PREFERENCES.SAVE" | translate }}
      </button>
    </div>
  </section>

  <!-- Change Password Section -->
  <section class="card password-section">
    <h3>{{ "SETTINGS.CHANGE_PASSWORD.TITLE" | translate }}</h3>
    <p class="section-description">
      {{ "SETTINGS.CHANGE_PASSWORD.DESCRIPTION" | translate }}
    </p>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.CHANGE_PASSWORD.CURRENT_PASSWORD" | translate
      }}</label>
      <input
        type="password"
        [(ngModel)]="currentPassword"
        placeholder="{{
          'SETTINGS.CHANGE_PASSWORD.CURRENT_PASSWORD_PLACEHOLDER' | translate
        }}"
        autocomplete="current-password"
      />
    </div>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.CHANGE_PASSWORD.NEW_PASSWORD" | translate
      }}</label>
      <input
        type="password"
        [(ngModel)]="newPassword"
        placeholder="{{
          'SETTINGS.CHANGE_PASSWORD.NEW_PASSWORD_PLACEHOLDER' | translate
        }}"
        autocomplete="new-password"
      />
    </div>

    <div class="form-row">
      <label class="label">{{
        "SETTINGS.CHANGE_PASSWORD.CONFIRM_PASSWORD" | translate
      }}</label>
      <input
        type="password"
        [(ngModel)]="confirmPassword"
        placeholder="{{
          'SETTINGS.CHANGE_PASSWORD.CONFIRM_PASSWORD_PLACEHOLDER' | translate
        }}"
        autocomplete="new-password"
      />
    </div>

    <div class="form-actions">
      <button
        class="btn btn-primary"
        (click)="changePassword()"
        [disabled]="changingPassword"
      >
        @if (changingPassword) {
          <i class="fas fa-spinner fa-spin"></i>
        }
        @if (!changingPassword) {
          <i class="fas fa-key"></i>
        }
        {{ "SETTINGS.CHANGE_PASSWORD.BUTTON" | translate }}
      </button>
    </div>
  </section>

  <!-- Digital Scale Section -->
  <section class="card scale-section">
    <h3>
      <i class="fas fa-weight"></i>
      {{ "SETTINGS.SCALE.TITLE" | translate }}
    </h3>
    <p class="section-description">
      {{ "SETTINGS.SCALE.DESCRIPTION" | translate }}
    </p>

    <div class="scale-status-container">
      <div
        class="scale-status-badge"
        [class.connected]="scaleConnected"
        [class.disconnected]="!scaleConnected"
      >
        <i
          [class.fa-link]="scaleConnected"
          [class.fa-unlink]="!scaleConnected"
          class="fas"
        ></i>
        <span>
          {{
            scaleConnected
              ? ("SETTINGS.SCALE.STATUS_CONNECTED" | translate)
              : ("SETTINGS.SCALE.STATUS_DISCONNECTED" | translate)
          }}
        </span>
      </div>

      @if (scaleConnected && currentWeight > 0) {
        <div class="scale-reading">
          <div class="weight-display">
            <span class="weight-value">{{
              currentWeight | number: "1.3-3"
            }}</span>
            <span class="weight-unit">{{ currentWeightUnit }}</span>
            <span
              class="stability-indicator"
              [class.stable]="currentWeightStable"
              [class.unstable]="!currentWeightStable"
            >
              <i
                [class.fa-check-circle]="currentWeightStable"
                [class.fa-sync]="!currentWeightStable"
                [class.fa-spin]="!currentWeightStable"
                class="fas"
              ></i>
              {{
                currentWeightStable
                  ? ("SETTINGS.SCALE.STABLE" | translate)
                  : ("SETTINGS.SCALE.STABILIZING" | translate)
              }}
            </span>
          </div>
        </div>
      }
    </div>

    <div class="form-actions">
      @if (!scaleConnected) {
        <button
          class="btn btn-primary"
          (click)="connectScale()"
          [disabled]="connectingScale"
        >
          @if (connectingScale) {
            <i class="fas fa-spinner fa-spin"></i>
          }
          @if (!connectingScale) {
            <i class="fas fa-link"></i>
          }
          {{ "SETTINGS.SCALE.CONNECT" | translate }}
        </button>
      }
      @if (scaleConnected) {
        <button class="btn btn-danger" (click)="disconnectScale()">
          <i class="fas fa-unlink"></i>
          {{ "SETTINGS.SCALE.DISCONNECT" | translate }}
        </button>
      }
    </div>
  </section>

  <!-- Login QR Badge Section -->
  <section class="card qr-badge-section">
    <h3>{{ "SETTINGS.QR_BADGE.TITLE" | translate }}</h3>
    <p class="section-description">
      {{ "SETTINGS.QR_BADGE.DESCRIPTION" | translate }}
    </p>

    <div class="qr-preview">
      <div class="qr-code-container">
        <img [src]="qrCodeUrl" alt="Login QR Code" class="qr-code-image" />
      </div>
      <div class="qr-info">
        <p class="user-name">{{ currentUserName }}</p>
        <p class="user-role">{{ currentUserRole }}</p>
      </div>
    </div>

    <div class="form-actions">
      <button
        class="btn btn-primary"
        (click)="printQrBadge()"
        [disabled]="printingBadge"
      >
        @if (printingBadge) {
          <i class="fas fa-spinner fa-spin"></i>
        }
        @if (!printingBadge) {
          <i class="fas fa-print"></i>
        }
        {{ "SETTINGS.QR_BADGE.PRINT" | translate }}
      </button>
    </div>
  </section>

  <!-- Reset Database Section (Admin Only) -->
  @if (isAdmin) {
    <section class="card reset-db-section danger-zone">
      <h3>{{ "SETTINGS.RESET_DB.TITLE" | translate }}</h3>
      <p class="section-description danger-description">
        {{ "SETTINGS.RESET_DB.DESCRIPTION" | translate }}
      </p>

      <div class="reset-db-content">
        <div class="warning-box">
          <i class="fas fa-exclamation-circle"></i>
          <p>{{ "SETTINGS.RESET_DB.WARNING" | translate }}</p>
        </div>

        @if (!showResetDBConfirm) {
          <button
            class="btn btn-danger"
            (click)="toggleResetDBConfirm()"
            title="Reset database (admin only)"
          >
            <i class="fas fa-redo-alt"></i>
            {{ "SETTINGS.RESET_DB.BUTTON" | translate }}
          </button>
        } @else {
          <div class="reset-confirmation-box">
            <p class="confirmation-label">
              {{ "SETTINGS.RESET_DB.CONFIRM_LABEL" | translate }}
            </p>
            <input
              type="text"
              [(ngModel)]="resetConfirmationText"
              placeholder="{{
                'SETTINGS.RESET_DB.CONFIRM_PLACEHOLDER' | translate
              }}"
              class="confirmation-input"
              (keyup.enter)="resetDatabase()"
            />
            <div class="confirmation-actions">
              <button
                class="btn btn-secondary"
                (click)="toggleResetDBConfirm()"
                [disabled]="resettingDatabase"
              >
                <i class="fas fa-times"></i>
                {{ "GLOBAL.CANCEL" | translate }}
              </button>
              <button
                class="btn btn-danger"
                (click)="resetDatabase()"
                [disabled]="
                  resettingDatabase ||
                  resetConfirmationText.toLowerCase() !== 'confirm'
                "
              >
                @if (resettingDatabase) {
                  <i class="fas fa-spinner fa-spin"></i>
                } @else {
                  <i class="fas fa-exclamation-triangle"></i>
                }
                {{ "SETTINGS.RESET_DB.CONFIRM_BUTTON" | translate }}
              </button>
            </div>
          </div>
        }
      </div>
    </section>
  }
</div>
