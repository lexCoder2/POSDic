<!-- eslint-disable @angular-eslint/template/click-events-have-key-events -->
<div class="pos-content">
  <!-- Products Section -->
  <div class="products-section">
    <!-- Action Buttons Bar -->
    <div class="action-buttons-bar">
      <button
        class="action-btn"
        [class.register-open]="currentRegister"
        [class.register-closed]="!currentRegister"
        (click)="toggleRegister()"
      >
        <i
          class="fas"
          [class.fa-cash-register]="!currentRegister"
          [class.fa-door-open]="currentRegister"
        ></i>
        <span>{{
          (currentRegister
            ? "POS.ACTIONS.CLOSE_REGISTER"
            : "POS.ACTIONS.OPEN_REGISTER"
          ) | translate
        }}</span>
      </button>

      <button class="action-btn" (click)="openCalculatorModal()">
        <i class="fas fa-calculator"></i>
        <span>{{ "POS.ACTIONS.CALCULATOR" | translate }}</span>
      </button>

      <button class="action-btn" (click)="openLooseProductModal()">
        <i class="fas fa-balance-scale"></i>
        <span>{{ "POS.ACTIONS.LOOSE" | translate }}</span>
      </button>

      <button
        class="action-btn"
        [disabled]="!currentRegister"
        (click)="openWithdrawModal()"
      >
        <i class="fas fa-money-bill-wave"></i>
        <span>{{ "POS.ACTIONS.WITHDRAW" | translate }}</span>
      </button>

      <button class="action-btn" (click)="openReturnsModal()">
        <i class="fas fa-undo-alt"></i>
        <span>{{ "POS.ACTIONS.RETURNS" | translate }}</span>
      </button>
    </div>

    <!-- Search Results Component -->
    <app-search-results
      [products]="searchResults"
      [isLoading]="isSearching"
      (productSelected)="addToCart($event)"
    ></app-search-results>

    <!-- Bottom Section: Favorites and Quick Access Tabs (hidden on mobile) -->
    @if (!isMobileView) {
      <div class="bottom-tabs-container">
        <div class="tabs-header">
          <button
            class="tab-btn"
            [class.active]="bottomTab === 'favorites'"
            (click)="bottomTab = 'favorites'"
          >
            <i class="fas fa-star"></i>
            {{ "POS.FAVORITES" | translate }}
          </button>
          <button
            class="tab-btn"
            [class.active]="bottomTab === 'quick-access'"
            (click)="bottomTab = 'quick-access'"
          >
            <i class="fas fa-bolt"></i>
            {{ "POS.QUICK_ACCESS" | translate }}
          </button>
        </div>
        <div class="tabs-content">
          @if (bottomTab === "favorites") {
            <app-favorites
              (productSelected)="addToCart($event)"
            ></app-favorites>
          }
          @if (bottomTab === "quick-access") {
            <app-quick-access
              [products]="quickAccessProducts"
              (productSelected)="addToCart($event)"
            ></app-quick-access>
          }
        </div>
      </div>
    }
  </div>

  <!-- Cart Component -->
  <app-cart
    [cartItems]="cartItems"
    [salesTabs]="salesTabs"
    [activeSaleTabIndex]="activeSaleTabIndex"
    [isMobileCartOpen]="isMobileCartOpen"
    [registerOpen]="!!currentRegister"
    [canMakeInternalSale]="canMakeInternalSale"
    [cartId]="currentCartId"
    (switchTab)="switchSaleTab($event)"
    (addTab)="addSaleTab()"
    (closeTab)="closeSaleTab($event)"
    (removeItem)="removeFromCart($event)"
    (clearCart)="cartService.clearCart()"
    (placeOrder)="openCheckout()"
    (placeOrderWithMethod)="handleQuickPay()"
    (internalSale)="openInternalSale()"
    (closeMobileCart)="toggleMobileCart()"
    (priceChanged)="onItemPriceChanged($event)"
  ></app-cart>
</div>

<!-- Camera Scanner Component -->
<app-camera-scanner
  [isActive]="isCameraActive"
  (barcodeDetected)="onCameraBarcodeDetected($event)"
  (close)="isCameraActive = false"
>
</app-camera-scanner>

<!-- Checkout Modal Component -->
<app-checkout-modal
  [show]="showCheckout"
  [cartItems]="cartItems"
  [total]="total"
  (close)="closeCheckout()"
  (completeSale)="onCheckoutComplete($event)"
>
</app-checkout-modal>

<!-- Weight Modal Component -->
<app-weight-modal
  [show]="showWeightModal"
  [product]="weightModalProduct"
  [scaleConnected]="scaleConnected"
  [savedWeight]="savedWeight"
  [savedWeightUnit]="savedWeightUnit"
  (close)="closeWeightModal()"
  (confirmWeight)="onWeightConfirm($event)"
>
</app-weight-modal>

<!-- Quick Product Modal Component -->
<app-quick-product-modal
  [show]="showQuickProductModal"
  [barcode]="quickProductBarcode"
  (close)="closeQuickProductModal()"
  (createProduct)="onQuickProductCreate($event)"
>
</app-quick-product-modal>

<!-- Internal Sale Modal Component -->
<app-internal-sale-modal
  [show]="showInternalSaleConfirm"
  [cartItems]="cartItems"
  [total]="total"
  [currentUser]="currentUser"
  (close)="closeInternalSale()"
  (confirm)="onInternalSaleConfirm($event)"
>
</app-internal-sale-modal>

<!-- Mobile Favorites Bar (Fixed at Bottom) -->
@if (!isMobileView) {
  <div class="mobile-favorites-bar">
    <div class="favorites-header">
      <i class="fas fa-star"></i>
      <span>{{ "POS.MOBILE_QUICK_ACCESS" | translate }}</span>
    </div>
    <div class="favorites-scroll">
      @for (product of quickAccessProducts; track product.ean) {
        <button
          type="button"
          class="favorite-item"
          (click)="addToCart(product)"
          [attr.aria-label]="
            product.name + ' - ' + (product.price | appCurrency)
          "
        >
          <div class="favorite-image">
            @if (product.local_image) {
              <img
                [src]="getProductImageUrl(product)"
                [alt]="product.name"
                (error)="
                  $any($event.target).src =
                    'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect width=%2250%22 height=%2250%22 fill=%22%23f0f0f0%22/%3E%3Ctext x=%2225%22 y=%2232%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3EðŸ“¦%3C/text%3E%3C/svg%3E'
                "
              />
            } @else {
              <div class="no-image">
                <i class="fas fa-box"></i>
              </div>
            }
          </div>
          <div class="favorite-name">{{ product.name }}</div>
          <div class="favorite-price">{{ product.price | appCurrency }}</div>
        </button>
      }
    </div>
  </div>
}

<!-- Calculator Modal -->
<app-modal
  [show]="showCalculatorModal"
  [title]="'POS.CALCULATOR.TITLE' | translate"
  icon="fas fa-calculator"
  size="md"
  (close)="closeCalculatorModal()"
>
  <app-calculator
    (addItem)="onCalculatorAddGeneric($event)"
    (looseProductRequest)="openLooseProductModal()"
  >
  </app-calculator>
</app-modal>

<!-- Loose Product Modal Component -->
<app-loose-product-modal
  [show]="showLooseProductModal"
  [scaleConnected]="scaleConnected"
  [savedWeight]="savedWeight"
  (close)="closeLooseProductModal()"
  (confirm)="onLooseProductConfirm($event)"
>
</app-loose-product-modal>

<!-- Withdraw Modal -->
<app-modal
  [show]="showWithdrawModal"
  [title]="'WITHDRAW.TITLE' | translate"
  icon="fas fa-money-bill-wave"
  size="md"
  customClass="withdraw-modal"
  (close)="closeWithdrawModal()"
>
  <div class="form-group">
    <label for="withdrawAmount">
      <i class="fas fa-dollar-sign"></i>
      {{ "WITHDRAW.AMOUNT" | translate }}
    </label>
    <div class="input-wrapper">
      <span class="currency">$</span>
      <input
        id="withdrawAmount"
        type="number"
        [(ngModel)]="withdrawAmount"
        min="0"
        step="0.01"
        class="form-control amount-input"
        placeholder="0.00"
      />
    </div>
  </div>
  <div class="form-group">
    <label for="withdrawReason">
      <i class="fas fa-comment-alt"></i>
      {{ "WITHDRAW.REASON" | translate }}
    </label>
    <textarea
      id="withdrawReason"
      [(ngModel)]="withdrawReason"
      class="form-control"
      rows="3"
      [placeholder]="'WITHDRAW.REASON_PLACEHOLDER' | translate"
    ></textarea>
  </div>

  <div class="modal-footer" modal-footer>
    <button class="btn-cancel" (click)="closeWithdrawModal()">
      {{ "GLOBAL.CANCEL" | translate }}
    </button>
    <button
      class="btn-confirm"
      [disabled]="!withdrawAmount || withdrawAmount <= 0"
      (click)="confirmWithdraw()"
    >
      <i class="fas fa-check"></i>
      {{ "WITHDRAW.CONFIRM" | translate }}
    </button>
  </div>
</app-modal>

<!-- Open Register Modal -->
<app-modal
  [show]="showOpenRegisterModal"
  [title]="''"
  [showCloseButton]="false"
  size="md"
  (close)="closeOpenRegisterModal()"
>
  <app-open-register
    (registerOpened)="onRegisterOpened()"
    (cancelled)="closeOpenRegisterModal()"
  ></app-open-register>
</app-modal>

<!-- Close Register Modal -->
<app-modal
  [show]="showCloseRegisterModal"
  [title]="'POS.REGISTER.CLOSE_TITLE' | translate"
  icon="fas fa-door-closed"
  size="md"
  customClass="register-modal"
  (close)="closeCloseRegisterModal()"
>
  <div class="register-summary">
    <div class="summary-row">
      <span>{{ "POS.REGISTER.OPENING_CASH" | translate }}:</span>
      <span class="value">{{
        currentRegister?.openingCash || 0 | appCurrency
      }}</span>
    </div>
    <div class="summary-row">
      <span>{{ "POS.REGISTER.EXPECTED_CASH" | translate }}:</span>
      <span class="value highlight">{{ expectedCash | appCurrency }}</span>
    </div>
  </div>
  <div class="form-group">
    <label for="closingCash">
      <i class="fas fa-dollar-sign"></i>
      {{ "POS.REGISTER.CLOSING_CASH" | translate }}
    </label>
    <div class="input-wrapper">
      <span class="currency">$</span>
      <input
        id="closingCash"
        type="number"
        [(ngModel)]="closingCash"
        min="0"
        step="0.01"
        class="form-control amount-input"
        placeholder="0.00"
      />
    </div>
    @if (closingCash !== null && closingCash !== undefined) {
      <div class="difference">
        <span
          [class.positive]="closingCash - expectedCash >= 0"
          [class.negative]="closingCash - expectedCash < 0"
        >
          {{ "POS.REGISTER.DIFFERENCE" | translate }}:
          {{ closingCash - expectedCash | appCurrency }}
        </span>
      </div>
    }
    <div class="form-group">
      <label for="registerNotes">
        <i class="fas fa-sticky-note"></i>
        {{ "POS.REGISTER.NOTES" | translate }}
      </label>
      <textarea
        id="registerNotes"
        [(ngModel)]="closeRegisterNotes"
        class="form-control"
        rows="2"
        [placeholder]="'POS.REGISTER.NOTES_PLACEHOLDER' | translate"
      ></textarea>
    </div>
  </div>

  <div class="modal-footer" modal-footer>
    <button class="btn-cancel" (click)="closeCloseRegisterModal()">
      {{ "GLOBAL.CANCEL" | translate }}
    </button>
    <button
      class="btn-confirm danger"
      [disabled]="closingCash === null || closingCash === undefined"
      (click)="confirmCloseRegister()"
    >
      <i class="fas fa-lock"></i>
      {{ "POS.REGISTER.CLOSE" | translate }}
    </button>
  </div>
</app-modal>

<!-- Returns Modal -->
<app-returns-modal
  [show]="showReturnsModal"
  (close)="closeReturnsModal()"
  (refundComplete)="onRefundComplete($event)"
></app-returns-modal>

<!-- Mobile Scan Floating Button -->
<button
  class="mobile-scan-button"
  aria-label="Start camera scan"
  (click)="toggleCameraScanner()"
  title="{{ 'POS.BUTTONS.SCAN' | translate }}"
>
  <i class="fas fa-camera"></i>
</button>
