<div class="pos-content">
  <!-- Products Section -->
  <div class="products-section">
    <!-- Action Buttons Bar -->
    <div class="action-buttons-bar">
      <button
        class="action-btn"
        [class.register-open]="currentRegister"
        [class.register-closed]="!currentRegister"
        (click)="toggleRegister()"
      >
        <i
          class="fas"
          [class.fa-cash-register]="!currentRegister"
          [class.fa-door-open]="currentRegister"
        ></i>
        <span>{{
          (currentRegister
            ? "POS.ACTIONS.CLOSE_REGISTER"
            : "POS.ACTIONS.OPEN_REGISTER"
          ) | translate
        }}</span>
      </button>

      <button class="action-btn" (click)="openCalculatorModal()">
        <i class="fas fa-calculator"></i>
        <span>{{ "POS.ACTIONS.CALCULATOR" | translate }}</span>
      </button>

      <button class="action-btn" (click)="openLooseProductModal()">
        <i class="fas fa-balance-scale"></i>
        <span>{{ "POS.ACTIONS.LOOSE" | translate }}</span>
      </button>

      <button
        class="action-btn"
        [disabled]="!currentRegister"
        (click)="openWithdrawModal()"
      >
        <i class="fas fa-money-bill-wave"></i>
        <span>{{ "POS.ACTIONS.WITHDRAW" | translate }}</span>
      </button>

      <button class="action-btn" (click)="openReturnsModal()">
        <i class="fas fa-undo-alt"></i>
        <span>{{ "POS.ACTIONS.RETURNS" | translate }}</span>
      </button>
    </div>

    <!-- Search Results Component -->
    <app-search-results
      [products]="searchResults"
      [isLoading]="isSearching"
      (productSelected)="addToCart($event)"
    ></app-search-results>

    <!-- Bottom Section: Favorites and Quick Access Tabs (hidden on mobile) -->
    <div class="bottom-tabs-container" *ngIf="!isMobileView">
      <div class="tabs-header">
        <button
          class="tab-btn"
          [class.active]="bottomTab === 'favorites'"
          (click)="bottomTab = 'favorites'"
        >
          <i class="fas fa-star"></i>
          {{ "POS.FAVORITES" | translate }}
        </button>
        <button
          class="tab-btn"
          [class.active]="bottomTab === 'quick-access'"
          (click)="bottomTab = 'quick-access'"
        >
          <i class="fas fa-bolt"></i>
          {{ "POS.QUICK_ACCESS" | translate }}
        </button>
      </div>
      <div class="tabs-content">
        <app-favorites
          *ngIf="bottomTab === 'favorites'"
          (productSelected)="addToCart($event)"
        ></app-favorites>

        <app-quick-access
          *ngIf="bottomTab === 'quick-access'"
          [products]="quickAccessProducts"
          (productSelected)="addToCart($event)"
        ></app-quick-access>
      </div>
    </div>
  </div>

  <!-- Cart Component -->
  <app-cart
    [cartItems]="cartItems"
    [salesTabs]="salesTabs"
    [activeSaleTabIndex]="activeSaleTabIndex"
    [isMobileCartOpen]="isMobileCartOpen"
    [registerOpen]="!!currentRegister"
    [canMakeInternalSale]="canMakeInternalSale"
    (switchTab)="switchSaleTab($event)"
    (addTab)="addSaleTab()"
    (closeTab)="closeSaleTab($event)"
    (removeItem)="removeFromCart($event)"
    (clearCart)="cartService.clearCart()"
    (placeOrder)="openCheckout()"
    (placeOrderWithMethod)="handleQuickPay($event)"
    (internalSale)="openInternalSale()"
    (closeMobileCart)="toggleMobileCart()"
  ></app-cart>
</div>

<!-- Camera Scanner Component -->
<app-camera-scanner
  [isActive]="isCameraActive"
  (barcodeDetected)="onCameraBarcodeDetected($event)"
  (close)="isCameraActive = false"
>
</app-camera-scanner>

<!-- Checkout Modal Component -->
<app-checkout-modal
  [show]="showCheckout"
  [cartItems]="cartItems"
  [total]="total"
  (close)="closeCheckout()"
  (completeSale)="onCheckoutComplete($event)"
>
</app-checkout-modal>

<!-- Weight Modal Component -->
<app-weight-modal
  [show]="showWeightModal"
  [product]="weightModalProduct"
  [scaleConnected]="scaleConnected"
  [currentWeight]="currentWeight"
  [currentWeightUnit]="currentWeightUnit"
  [currentWeightStable]="currentWeightStable"
  (close)="closeWeightModal()"
  (confirmWeight)="onWeightConfirm($event)"
>
</app-weight-modal>

<!-- Quick Product Modal Component -->
<app-quick-product-modal
  [show]="showQuickProductModal"
  [barcode]="quickProductBarcode"
  (close)="closeQuickProductModal()"
  (createProduct)="onQuickProductCreate($event)"
>
</app-quick-product-modal>

<!-- Internal Sale Modal Component -->
<app-internal-sale-modal
  [show]="showInternalSaleConfirm"
  [cartItems]="cartItems"
  [total]="total"
  [currentUser]="currentUser"
  (close)="closeInternalSale()"
  (confirm)="onInternalSaleConfirm($event)"
>
</app-internal-sale-modal>

<!-- Mobile Favorites Bar (Fixed at Bottom) -->
<div class="mobile-favorites-bar" *ngIf="!isMobileView">
  <div class="favorites-header">
    <i class="fas fa-star"></i>
    <span>{{ "POS.MOBILE_QUICK_ACCESS" | translate }}</span>
  </div>
  <div class="favorites-scroll">
    <div
      class="favorite-item"
      *ngFor="let product of quickAccessProducts"
      (click)="addToCart(product)"
    >
      <div class="favorite-image">
        <img
          *ngIf="product.local_image"
          [src]="getProductImageUrl(product)"
          [alt]="product.name"
          (error)="
            $any($event.target).src =
              'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect width=%2250%22 height=%2250%22 fill=%22%23f0f0f0%22/%3E%3Ctext x=%2225%22 y=%2232%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3EðŸ“¦%3C/text%3E%3C/svg%3E'
          "
        />
        <div *ngIf="!product.local_image" class="no-image">
          <i class="fas fa-box"></i>
        </div>
      </div>
      <div class="favorite-name">{{ product.name }}</div>
      <div class="favorite-price">{{ product.price | appCurrency }}</div>
    </div>
  </div>
</div>

<!-- Calculator Modal -->
<div
  class="modal-overlay"
  *ngIf="showCalculatorModal"
  (click)="closeCalculatorModal()"
>
  <div
    class="modal-content calculator-modal"
    (click)="$event.stopPropagation()"
  >
    <div class="modal-header">
      <h3>
        <i class="fas fa-calculator"></i>
        {{ "POS.CALCULATOR.TITLE" | translate }}
      </h3>
      <button class="btn-close" (click)="closeCalculatorModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="calculator-info">
        <i class="fas fa-info-circle"></i>
        <p>{{ "POS.CALCULATOR.INFO" | translate }}</p>
      </div>

      <app-calculator
        (addItem)="onCalculatorAddGeneric($event)"
        (looseProductRequest)="openLooseProductModal()"
      >
      </app-calculator>
    </div>
  </div>
</div>

<!-- Loose Product Modal Component -->
<app-loose-product-modal
  [show]="showLooseProductModal"
  [scaleConnected]="scaleConnected"
  [currentWeight]="currentWeight"
  [currentWeightStable]="currentWeightStable"
  (close)="closeLooseProductModal()"
  (confirm)="onLooseProductConfirm($event)"
>
</app-loose-product-modal>

<!-- Withdraw Modal -->
<div
  class="modal-overlay"
  *ngIf="showWithdrawModal"
  (click)="closeWithdrawModal()"
>
  <div class="modal-content withdraw-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-money-bill-wave"></i>
        {{ "POS.WITHDRAW.TITLE" | translate }}
      </h3>
      <button class="btn-close" (click)="closeWithdrawModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>
          <i class="fas fa-dollar-sign"></i>
          {{ "POS.WITHDRAW.AMOUNT" | translate }}
        </label>
        <div class="input-wrapper">
          <span class="currency">$</span>
          <input
            type="number"
            [(ngModel)]="withdrawAmount"
            min="0"
            step="0.01"
            class="form-control amount-input"
            placeholder="0.00"
          />
        </div>
      </div>
      <div class="form-group">
        <label>
          <i class="fas fa-comment-alt"></i>
          {{ "POS.WITHDRAW.REASON" | translate }}
        </label>
        <textarea
          [(ngModel)]="withdrawReason"
          class="form-control"
          rows="3"
          [placeholder]="'POS.WITHDRAW.REASON_PLACEHOLDER' | translate"
        ></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeWithdrawModal()">
        {{ "GLOBAL.CANCEL" | translate }}
      </button>
      <button
        class="btn-confirm"
        [disabled]="!withdrawAmount || withdrawAmount <= 0"
        (click)="confirmWithdraw()"
      >
        <i class="fas fa-check"></i>
        {{ "POS.WITHDRAW.CONFIRM" | translate }}
      </button>
    </div>
  </div>
</div>

<!-- Open Register Modal -->
<div
  class="modal-overlay"
  *ngIf="showOpenRegisterModal"
  (click)="closeOpenRegisterModal()"
>
  <div class="modal-content register-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>
        <i class="fas fa-cash-register"></i>
        {{ "POS.REGISTER.OPEN_TITLE" | translate }}
      </h3>
      <button class="btn-close" (click)="closeOpenRegisterModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>
          <i class="fas fa-hashtag"></i>
          {{ "POS.REGISTER.NUMBER" | translate }}
        </label>
        <input
          type="text"
          [(ngModel)]="registerNumber"
          class="form-control"
          [placeholder]="'POS.REGISTER.NUMBER_PLACEHOLDER' | translate"
        />
      </div>
      <div class="form-group">
        <label>
          <i class="fas fa-dollar-sign"></i>
          {{ "POS.REGISTER.OPENING_CASH" | translate }}
        </label>
        <div class="input-wrapper">
          <span class="currency">$</span>
          <input
            type="number"
            [(ngModel)]="openingCash"
            min="0"
            step="0.01"
            class="form-control amount-input"
            placeholder="0.00"
          />
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeOpenRegisterModal()">
        {{ "GLOBAL.CANCEL" | translate }}
      </button>
      <button
        class="btn-confirm"
        [disabled]="!registerNumber"
        (click)="confirmOpenRegister()"
      >
        <i class="fas fa-door-open"></i>
        {{ "POS.REGISTER.OPEN" | translate }}
      </button>
    </div>
  </div>
</div>

<!-- Close Register Modal -->
<div
  class="modal-overlay"
  *ngIf="showCloseRegisterModal"
  (click)="closeCloseRegisterModal()"
>
  <div class="modal-content register-modal" (click)="$event.stopPropagation()">
    <div class="modal-header warning">
      <h3>
        <i class="fas fa-door-closed"></i>
        {{ "POS.REGISTER.CLOSE_TITLE" | translate }}
      </h3>
      <button class="btn-close" (click)="closeCloseRegisterModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="register-summary">
        <div class="summary-row">
          <span>{{ "POS.REGISTER.OPENING_CASH" | translate }}:</span>
          <span class="value">{{
            currentRegister?.openingCash || 0 | appCurrency
          }}</span>
        </div>
        <div class="summary-row">
          <span>{{ "POS.REGISTER.EXPECTED_CASH" | translate }}:</span>
          <span class="value highlight">{{ expectedCash | appCurrency }}</span>
        </div>
      </div>
      <div class="form-group">
        <label>
          <i class="fas fa-dollar-sign"></i>
          {{ "POS.REGISTER.CLOSING_CASH" | translate }}
        </label>
        <div class="input-wrapper">
          <span class="currency">$</span>
          <input
            type="number"
            [(ngModel)]="closingCash"
            min="0"
            step="0.01"
            class="form-control amount-input"
            placeholder="0.00"
          />
        </div>
        <div
          class="difference"
          *ngIf="closingCash !== null && closingCash !== undefined"
        >
          <span
            [class.positive]="closingCash - expectedCash >= 0"
            [class.negative]="closingCash - expectedCash < 0"
          >
            {{ "POS.REGISTER.DIFFERENCE" | translate }}:
            {{ closingCash - expectedCash | appCurrency }}
          </span>
        </div>
      </div>
      <div class="form-group">
        <label>
          <i class="fas fa-sticky-note"></i>
          {{ "POS.REGISTER.NOTES" | translate }}
        </label>
        <textarea
          [(ngModel)]="closeRegisterNotes"
          class="form-control"
          rows="2"
          [placeholder]="'POS.REGISTER.NOTES_PLACEHOLDER' | translate"
        ></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" (click)="closeCloseRegisterModal()">
        {{ "GLOBAL.CANCEL" | translate }}
      </button>
      <button
        class="btn-confirm danger"
        [disabled]="closingCash === null || closingCash === undefined"
        (click)="confirmCloseRegister()"
      >
        <i class="fas fa-lock"></i>
        {{ "POS.REGISTER.CLOSE" | translate }}
      </button>
    </div>
  </div>
</div>

<!-- Returns Modal -->
<app-returns-modal
  [show]="showReturnsModal"
  (close)="closeReturnsModal()"
  (refundComplete)="onRefundComplete($event)"
></app-returns-modal>

<!-- Mobile Scan Floating Button -->
<button
  class="mobile-scan-button"
  aria-label="Start camera scan"
  (click)="toggleCameraScanner()"
  title="{{ 'POS.BUTTONS.SCAN' | translate }}"
>
  <i class="fas fa-camera"></i>
</button>
