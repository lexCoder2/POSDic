<div class="pos-container">
  <!-- Header -->
  <header class="pos-header">
    <div class="header-left">
      <h1>üè™ POS System</h1>
      <span class="user-badge"
        >{{ currentUser?.firstName }} {{ currentUser?.lastName }}</span
      >
    </div>
    <div class="header-right">
      <button
        class="btn-icon"
        (click)="navigateTo('/sales')"
        title="Sales History"
      >
        üìä
      </button>
      <button
        class="btn-icon"
        (click)="navigateTo('/products')"
        title="Products"
      >
        üì¶
      </button>
      <button
        class="btn-icon"
        (click)="navigateTo('/users')"
        *ngIf="currentUser?.role === 'admin' || currentUser?.role === 'manager'"
        title="Users"
      >
        üë•
      </button>
      <button
        class="btn-icon"
        (click)="navigateTo('/settings')"
        *ngIf="currentUser?.role === 'admin' || currentUser?.role === 'manager'"
        title="Settings"
      >
        ‚öôÔ∏è
      </button>
      <button class="btn-logout" (click)="logout()">Logout</button>
    </div>
  </header>

  <div class="pos-content">
    <!-- Left Panel - Products -->
    <div class="products-panel">
      <!-- Scanner Controls -->
      <div class="scanner-controls">
        <div class="barcode-input-group">
          <input
            #barcodeInput
            type="text"
            [(ngModel)]="barcodeValue"
            (keypress)="onBarcodeKeyPress($event)"
            placeholder="Scan or enter barcode"
            class="barcode-input"
          />
          <button class="btn-scan" (click)="toggleCameraScanner()">
            {{ isCameraActive ? "‚èπÔ∏è Stop" : "üì∑ Camera" }}
          </button>
          <button
            class="btn-scale"
            (click)="connectScale()"
            [class.active]="scaleConnected"
          >
            {{ scaleConnected ? "‚öñÔ∏è Connected" : "‚öñÔ∏è Scale" }}
          </button>
        </div>
        <div *ngIf="scaleConnected && currentWeight > 0" class="weight-display">
          Weight: {{ currentWeight | number : "1.3-3" }} kg
        </div>
      </div>

      <!-- Camera Scanner -->
      <div
        id="camera-scanner"
        *ngIf="isCameraActive"
        class="camera-scanner"
      ></div>

      <!-- Search -->
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchQuery"
          (input)="onSearchChange()"
          placeholder="üîç Search products..."
          class="search-input"
        />
      </div>

      <!-- Categories -->
      <div class="categories-grid">
        <button
          *ngFor="let category of categories"
          class="category-btn"
          [class.active]="selectedCategory === category._id"
          [style.background-color]="
            selectedCategory === category._id ? category.color : 'white'
          "
          [style.color]="
            selectedCategory === category._id ? 'white' : category.color
          "
          [style.border-color]="category.color"
          (click)="onCategorySelect(category._id!)"
        >
          {{ category.name }}
        </button>
      </div>

      <!-- Products Grid -->
      <div class="products-grid">
        <div
          *ngFor="let product of filteredProducts"
          class="product-card"
          (click)="addToCart(product)"
        >
          <div class="product-image">
            <img
              *ngIf="product.image_url || product.local_image"
              [src]="product.image_url || product.local_image"
              [alt]="product.name"
            />
            <div
              *ngIf="!product.image_url && !product.local_image"
              class="product-placeholder"
            >
              üì¶
            </div>
          </div>
          <div class="product-info">
            <h4>{{ product.name }}</h4>
            <p class="product-code">{{ product.product_id || product.sku }}</p>
            <p class="product-brand" *ngIf="product.brand">
              {{ product.brand }}
            </p>
            <p class="product-price">${{ product.price | number : "1.2-2" }}</p>
            <span
              *ngIf="product.stock! <= (product.minStock || 10)"
              class="stock-warning"
            >
              Low Stock: {{ product.stock }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Panel - Cart -->
    <div class="cart-panel">
      <h2>Cart</h2>

      <div class="cart-items">
        <div *ngIf="cartItems.length === 0" class="empty-cart">
          <p>üõí Cart is empty</p>
          <p class="help-text">Scan or click products to add</p>
        </div>

        <div *ngFor="let item of cartItems" class="cart-item">
          <div class="item-details">
            <h4>{{ item.product.name }}</h4>
            <p class="item-code">
              {{ item.product.product_id || item.product.sku }}
            </p>
            <p class="item-brand" *ngIf="item.product.brand">
              {{ item.product.brand }}
            </p>
            <p class="item-price">
              ${{ item.product.price | number : "1.2-2" }}
            </p>
          </div>

          <div class="item-controls">
            <div class="quantity-control">
              <button
                (click)="updateQuantity(item.product._id!, item.quantity - 1)"
              >
                -
              </button>
              <input
                type="number"
                [(ngModel)]="item.quantity"
                (change)="updateQuantity(item.product._id!, item.quantity)"
                min="0.001"
                [step]="item.product.requiresScale ? 0.001 : 1"
              />
              <button
                (click)="updateQuantity(item.product._id!, item.quantity + 1)"
              >
                +
              </button>
            </div>

            <div class="discount-control">
              <label>Discount %</label>
              <input
                type="number"
                [(ngModel)]="item.discount"
                (change)="updateDiscount(item.product._id!, item.discount)"
                min="0"
                max="100"
              />
            </div>

            <div class="item-total">
              ${{ getItemTotal(item) | number : "1.2-2" }}
            </div>

            <button
              class="btn-remove"
              (click)="removeFromCart(item.product._id!)"
            >
              üóëÔ∏è
            </button>
          </div>
        </div>
      </div>

      <div class="cart-summary">
        <div class="summary-row">
          <span>Subtotal:</span>
          <span>${{ subtotal | number : "1.2-2" }}</span>
        </div>
        <div class="summary-row discount">
          <span>Discount:</span>
          <span>-${{ totalDiscount | number : "1.2-2" }}</span>
        </div>
        <div class="summary-row">
          <span>Tax:</span>
          <span>${{ totalTax | number : "1.2-2" }}</span>
        </div>
        <div class="summary-row total">
          <span>Total:</span>
          <span>${{ total | number : "1.2-2" }}</span>
        </div>
      </div>

      <div class="cart-actions">
        <button class="btn-clear" (click)="cartService.clearCart()">
          Clear
        </button>
        <button
          class="btn-checkout"
          (click)="openCheckout()"
          [disabled]="cartItems.length === 0"
        >
          Checkout
        </button>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal" *ngIf="showCheckout">
    <div class="modal-content checkout-modal">
      <div class="modal-header">
        <h2>Checkout</h2>
        <button class="btn-close" (click)="closeCheckout()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="checkout-summary">
          <h3>Total: ${{ total | number : "1.2-2" }}</h3>
        </div>

        <div class="payment-method">
          <label>Payment Method:</label>
          <select [(ngModel)]="paymentMethod">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="transfer">Transfer</option>
            <option value="mixed">Mixed</option>
          </select>
        </div>

        <div class="payment-inputs">
          <div
            *ngIf="paymentMethod === 'cash' || paymentMethod === 'mixed'"
            class="payment-input"
          >
            <label>Cash Amount:</label>
            <input type="number" [(ngModel)]="cashAmount" min="0" step="0.01" />
          </div>

          <div
            *ngIf="paymentMethod === 'card' || paymentMethod === 'mixed'"
            class="payment-input"
          >
            <label>Card Amount:</label>
            <input type="number" [(ngModel)]="cardAmount" min="0" step="0.01" />
          </div>

          <div
            *ngIf="paymentMethod === 'transfer' || paymentMethod === 'mixed'"
            class="payment-input"
          >
            <label>Transfer Amount:</label>
            <input
              type="number"
              [(ngModel)]="transferAmount"
              min="0"
              step="0.01"
            />
          </div>

          <div
            *ngIf="
              (paymentMethod === 'cash' || paymentMethod === 'mixed') &&
              changeAmount > 0
            "
            class="change-display"
          >
            <strong>Change: ${{ changeAmount | number : "1.2-2" }}</strong>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeCheckout()">Cancel</button>
        <button class="btn-complete" (click)="completeSale()">
          Complete Sale
        </button>
      </div>
    </div>
  </div>
</div>
